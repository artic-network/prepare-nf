#! /usr/bin/env python

import os
import sys  
import argparse
import pandas as pd 
import re
import pathlib


def load_metadata(metadata_file):
    """
    Load metadata from a CSV or XLS file.
    This function should handle both formats and return a structured format (e.g., list of dictionaries).
    """
    if metadata_file.endswith('.csv'):
        with open(metadata_file, 'r') as f:
            return pd.read_csv(f)
    elif metadata_file.endswith('.xls') or metadata_file.endswith('.xlsx'):
        with open(metadata_file, 'r') as f:
            return pd.read_excel(f)
    else:
        raise ValueError("Unsupported metadata file format. Please use CSV or XLS/XLSX.")
    
def check_metadata(metadata):
    """
    Check if the metadata contains the required columns: 'sample', 'barcode', and any additional sample information.
    """
    required_columns = ['sample', 'barcode']
    for col in required_columns:
        if col not in metadata.columns:
            raise ValueError(f"Metadata file is missing required column: {col}")
        
    if not metadata['barcode'].unique().size == metadata['barcode'].size:
        raise ValueError("Metadata contains duplicate barcodes. Each barcode must be unique.")
    
    if not metadata['sample'].unique().size == metadata['sample'].size: 
        raise ValueError("Metadata contains duplicate sample names. Each sample name must be unique.")
    
    return True


def add_fastq_path_to_metadata(metadata, run_dir, platform):
    """
    Add the full path to the fastq files in the metadata DataFrame.
    This function assumes that the run_dir contains subdirectories named after barcodes.
    """
    if platform == 'ont':
        run_dir = pathlib.Path(run_dir).resolve()
        metadata['fastq_path'] = metadata.apply(
            lambda row: os.path.join(run_dir, row['barcode']), axis=1
        )
    else:
        raise ValueError(f"Unsupported platform '{platform}'. Only 'ont' is currently supported.")
    
    return metadata

def check_amplicon_scheme(amplicon_scheme):
    """
    Check if the amplicon scheme is in the correct format.
    """
    # Check if the amplicon scheme matches the expected format
    # Example format: 'artic-inrb-mpox/2500/v1.0.0'
    # This regex checks for a scheme name, followed by a slash, a version number with at least 3 digits, another slash, and a version identifier.
    if not re.match(r'^\S*\/\d{3,}\/v\d\.\d\.\d(-\S+)?$', amplicon_scheme):
        raise ValueError("Amplicon scheme must be in the format 'scheme/version/identifier  (e.g., artic-inrb-mpox/2500/v1.0.0)'.")
        
    return True

def save_metadata(metadata, output_file='sample_sheet.csv'):
    with open(output_file, 'w') as f:
        metadata = metadata[metadata['sample'].notna()]
        metadata.to_csv(f, index=False)

def main():
    parser = argparse.ArgumentParser(description="Create sample sheet from input data.")
    parser.add_argument("--platform", type=str, help="Platform.")
    parser.add_argument("--run_dir", type=str, help="Run directory")
    parser.add_argument("--metadata", type=str, help="Metadata file (CSV or XLS).")
    parser.add_argument("--amplicon_scheme", type=str, help="Amplicon scheme identifier (e.g., artic-inrb-mpox/2500/v1.0.0")
    args = parser.parse_args()

    args.platform = args.platform.lower()

    # Load metadata
    metadata = load_metadata(args.metadata)
    check_metadata(metadata)

    check_amplicon_scheme(args.amplicon_scheme)

    metadata = add_fastq_path_to_metadata(metadata, args.run_dir, args.platform)

    save_metadata(metadata, "sample_sheet.csv")


if __name__ == "__main__":
    main()

# todo: only allow excel spreadsheets generated by our templates
# todo: check dates in metadata if they are specified
